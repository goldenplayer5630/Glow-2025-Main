<UserControl
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ac="clr-namespace:Avalonia.Controls;assembly=Avalonia.Controls"
    xmlns:conv="using:Flower.App.Utilities"
    xmlns:vm="clr-namespace:Flower.App.ViewModels"
    x:Class="Flower.App.Views.ManageModBusesView"
    x:DataType="vm:IManageModBusesViewModel">

  <UserControl.Styles>
    <!-- Global controls -->
    <Style Selector="Button">
      <Setter Property="FontSize" Value="14"/>
      <Setter Property="MinHeight" Value="40"/>
      <Setter Property="Padding" Value="10,6"/>
      <Setter Property="CornerRadius" Value="6"/>
      <Setter Property="HorizontalContentAlignment" Value="Center"/>
      <Setter Property="VerticalContentAlignment" Value="Center"/>
    </Style>

    <Style Selector="ComboBox">
      <Setter Property="FontSize" Value="14"/>
      <Setter Property="MinHeight" Value="40"/>
      <Setter Property="Padding" Value="10,6"/>
      <Setter Property="HorizontalContentAlignment" Value="Left"/>
      <Setter Property="VerticalContentAlignment" Value="Center"/>
    </Style>

    <Style Selector="TextBox">
      <Setter Property="FontSize" Value="14"/>
      <Setter Property="MinHeight" Value="40"/>
      <Setter Property="Padding" Value="10,6"/>
      <Setter Property="HorizontalContentAlignment" Value="Left"/>
      <Setter Property="VerticalContentAlignment" Value="Center"/>
    </Style>

    <Style Selector="ac|NumericUpDown">
      <Setter Property="FontSize" Value="14"/>
      <Setter Property="MinHeight" Value="40"/>
      <Setter Property="Padding" Value="10,6"/>
    </Style>

    <Style Selector="ListBoxItem">
      <Setter Property="MinHeight" Value="44"/>
      <Setter Property="Padding" Value="8,6"/>
      <Setter Property="FontSize" Value="14"/>
    </Style>

    <Style Selector="TextBlock.header">
      <Setter Property="FontSize" Value="15"/>
      <Setter Property="FontWeight" Value="SemiBold"/>
    </Style>

    <Style Selector="TextBlock.subtle">
      <Setter Property="Opacity" Value="0.75"/>
      <Setter Property="FontSize" Value="13"/>
    </Style>
  </UserControl.Styles>

  <UserControl.Resources>
    <conv:ConnectionStatusToBrushConverter x:Key="StatusBrush" />
  </UserControl.Resources>

  <!-- Outer layout -->
  <Grid Margin="12" RowDefinitions="Auto,12,*">

    <!-- TOP STATUS -->
    <Border Grid.Row="0" Padding="10" Classes="card">
      <TextBlock Text="{Binding Status}" Classes="subtle" />
    </Border>

    <!-- MAIN CONTENT -->
    <Grid Grid.Row="2" ColumnDefinitions="2*,3*" ColumnSpacing="8">

      <!-- LEFT COLUMN: List -->
      <Grid Grid.Column="0">
        <Border Padding="10" Classes="card">
          <ListBox ItemsSource="{Binding Buses}" SelectedItem="{Binding Selected}">
            <ListBox.ItemTemplate>
              <DataTemplate>
                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" Margin="0,2">
                  <TextBlock Grid.Row="0" Grid.Column="0"
                             Text="{Binding BusId}"
                             FontWeight="SemiBold"/>

                  <Ellipse Grid.RowSpan="2"
                           Grid.Column="1"
                           Width="12" Height="12"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Right"
                           Margin="12,0,0,0">
                    <Ellipse.Fill>
                      <SolidColorBrush Color="{Binding ConnectionStatus, Converter={StaticResource StatusBrush}}"/>
                    </Ellipse.Fill>
                    <ac:ToolTip.Tip>
                      <TextBlock Text="{Binding ConnectionStatus}"/>
                    </ac:ToolTip.Tip>
                  </Ellipse>

                  <TextBlock Grid.Row="1" Grid.Column="0" Classes="subtle">
                    <Run Text="{Binding ModbusHost}" />
                    <Run Text=":" />
                    <Run Text="{Binding ModbusPort}" />
                    <Run Text=" - Unit " />
                    <Run Text="{Binding ModbusUnitId}" />
                  </TextBlock>
                </Grid>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>
        </Border>
      </Grid>

      <!-- Right: Editor + Actions -->
      <Grid Grid.Column="1" RowDefinitions="Auto,Auto" RowSpacing="8">

        <!-- Editor card -->
        <Border Grid.Row="0" Padding="10" Classes="card">
          <Grid RowDefinitions="Auto,6,Auto,6,Auto"
                ColumnDefinitions="*,8,*">

            <!-- Row 0: BusId + UnitId -->
            <StackPanel Grid.Row="0" Grid.Column="0" Spacing="2">
              <TextBlock Text="Bus Id:" Classes="header"/>
              <ComboBox ItemsSource="{Binding BusIdOptions}"
                        SelectedItem="{Binding EditBusId}"
                        IsEnabled="{Binding Selected, Converter={x:Static ObjectConverters.IsNull}}"/>
            </StackPanel>

            <StackPanel Grid.Row="0" Grid.Column="2" Spacing="2">
              <TextBlock Text="Unit Id:" Classes="header"/>
              <ac:NumericUpDown Value="{Binding EditUnitId}"
                                Minimum="1" Maximum="247" Increment="1"/>
            </StackPanel>

            <!-- Row 2: Host (full width) -->
            <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3" Spacing="2">
              <TextBlock Text="Host / IP:" Classes="header"/>
              <TextBox Text="{Binding EditHost}"
                       Watermark="192.168.1.200"/>
            </StackPanel>

            <!-- Row 4: TCP Port + Timeout -->
            <StackPanel Grid.Row="4" Grid.Column="0" Spacing="2">
              <TextBlock Text="TCP Port:" Classes="header"/>
              <ac:NumericUpDown Value="{Binding EditPort}"
                                Minimum="1" Maximum="65535" Increment="1"/>
            </StackPanel>

            <StackPanel Grid.Row="4" Grid.Column="2" Spacing="2">
              <TextBlock Text="Timeout (ms):" Classes="header"/>
              <ac:NumericUpDown Value="{Binding EditTimeoutMs}"
                                Minimum="100" Maximum="20000" Increment="100"/>
            </StackPanel>

          </Grid>
        </Border>

        <!-- Actions card -->
        <Border Grid.Row="1" Padding="10" Classes="card">
          <Grid RowDefinitions="Auto,8,Auto"
                ColumnDefinitions="*,*,*"
                ColumnSpacing="10">

            <!-- Row 1 -->
            <Button Grid.Row="0" Grid.Column="0" Content="Add" Command="{Binding AddCommand}"/>
            <Button Grid.Row="0" Grid.Column="1" Content="Update" Command="{Binding UpdateCommand}"/>
            <Button Grid.Row="0" Grid.Column="2" Content="Delete" Command="{Binding DeleteCommand}"/>

            <!-- Row 2 -->
            <Button Grid.Row="2" Grid.Column="0" Content="Test" Command="{Binding TestCommand}"/>
            <Button Grid.Row="2" Grid.Column="1" Content="Connect" Command="{Binding ConnectCommand}"/>
            <Button Grid.Row="2" Grid.Column="2" Content="Disconnect" Command="{Binding DisconnectCommand}"/>
          </Grid>
        </Border>

      </Grid>
    </Grid>
  </Grid>
</UserControl>
